
# Utilitza l'última versió de dind com a base
FROM docker:22.0.0-dind

# Instal·la les dependències
RUN apt-get update && apt-get install -y \
    openssh-server \
    python3 \
    python3-pip \
    nodejs \
    npm \
    curl \
    git \
    mysql-client \
    maven \
    gradle \
 && apt-get clean && rm -rf /var/lib/apt/lists/*

# Instal·la sdkman
RUN curl -s "https://get.sdkman.io" | bash

# Instal·la la versió més recent de docker-compose
RUN curl -L "https://github.com/docker/compose/releases/download/1.26.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
RUN chmod +x /usr/local/bin/docker-compose

# Configura el servidor ssh
RUN mkdir /var/run/sshd
RUN echo 'root:root' | chpasswd
RUN sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config

# Configura supervisor per gestionar els serveis
RUN apt-get update && apt-get install -y supervisor && apt-get clean && rm -rf /var/lib/apt/lists/*
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Definix els ports per a ssh i VSCode
EXPOSE 2222
EXPOSE 8081

# Configura el directori $HOME i els volums
VOLUME ["/var/lib/docker", "$HOME"]

# Defineix el comandament per a executar el contenidor
CMD ["/usr/bin/supervisord"]

